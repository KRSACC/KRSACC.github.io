<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>관리자 - KRSACC</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f5f5f5; margin:0; padding:20px; }
    h1 { text-align:center; margin: 8px 0 18px; }
    .card { background:#fff; border-radius:12px; padding:18px; margin:12px auto; max-width:760px; }
    .item { border:1px solid #eee; border-radius:10px; padding:12px; margin-top:10px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; }
    button { padding:10px 12px; border:none; border-radius:10px; background:#111; color:#fff; cursor:pointer; }
    button.secondary { background:#666; }
    button.danger { background:#b00020; }
    .muted { color:#777; font-size:13px; margin-top:6px; line-height:1.45; }
    input { width:100%; padding:10px; border:1px solid #ddd; border-radius:10px; margin-top:8px; }
  </style>
</head>
<body>

<h1>관리자 페이지</h1>

<div class="card">
  <div id="adminInfo" class="muted">확인 중...</div>
  <div class="row" style="margin-top:10px;">
    <button onclick="location.href='index.html'">메인으로</button>
    <button class="secondary" id="refreshBtn">새로고침</button>
  </div>
</div>

<div class="card">
  <h3>충전 요청 (대기중)</h3>
  <div id="pendingList">불러오는 중...</div>
</div>

<script type="module">
  import { auth, db } from "./firebase.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import {
    collection, query, where, orderBy, getDocs,
    doc, getDoc, updateDoc, increment
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const ADMIN_EMAIL = "killgg0108@gmail.com";
  const adminInfo = document.getElementById("adminInfo");
  const pendingList = document.getElementById("pendingList");
  const refreshBtn = document.getElementById("refreshBtn");

  function fmt(n){ return (n||0).toLocaleString(); }

  async function loadPending() {
    pendingList.innerHTML = "";
    const q = query(
      collection(db, "chargeRequests"),
      where("status", "==", "pending"),
      orderBy("createdAt", "desc")
    );
    const snap = await getDocs(q);

    if (snap.empty) {
      pendingList.innerHTML = `<div class="muted">대기중인 충전 요청이 없습니다.</div>`;
      return;
    }

    snap.forEach(d => {
      const r = d.data();
      const id = d.id;

      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div><b>${fmt(r.amount)}원</b> / 입금자명: <b>${r.depositor || "-"}</b></div>
        <div class="muted">요청자: ${r.email || r.uid}</div>
        <div class="muted">요청시간: ${r.createdAt ? new Date(r.createdAt).toLocaleString() : "-"}</div>
        <div style="margin-top:10px;">
          <input id="note-${id}" placeholder="메모(선택): 예) 12/15 21:10 입금확인" />
          <div class="row" style="margin-top:10px;">
            <button id="approve-${id}">승인(잔액 반영)</button>
            <button class="danger" id="reject-${id}">거절</button>
          </div>
        </div>
      `;
      pendingList.appendChild(div);

      document.getElementById(`approve-${id}`).onclick = async () => {
        const note = document.getElementById(`note-${id}`).value.trim();

        // 1) 유저 잔액 증가
        const userRef = doc(db, "users", r.uid);
        const userSnap = await getDoc(userRef);
        if (!userSnap.exists()) {
          alert("해당 유저 users 문서가 없습니다. (회원가입 시 users 생성이 필요)");
          return;
        }
        await updateDoc(userRef, { balance: increment(r.amount || 0) });

        // 2) 요청 상태 승인 처리
        await updateDoc(doc(db, "chargeRequests", id), {
          status: "approved",
          approvedAt: Date.now(),
          note: note || ""
        });

        alert("승인 완료: 잔액 반영됨");
        await loadPending();
      };

      document.getElementById(`reject-${id}`).onclick = async () => {
        const note = document.getElementById(`note-${id}`).value.trim();

        await updateDoc(doc(db, "chargeRequests", id), {
          status: "rejected",
          rejectedAt: Date.now(),
          note: note || ""
        });

        alert("거절 처리 완료");
        await loadPending();
      };
    });
  }

  refreshBtn.onclick = loadPending;

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      alert("관리자 로그인이 필요합니다.");
      location.href = "login.html";
      return;
    }
    if (user.email !== ADMIN_EMAIL) {
      alert("관리자만 접근 가능합니다.");
      location.href = "index.html";
      return;
    }

    adminInfo.innerText = "관리자 로그인: " + user.email;
    await loadPending();
  });
</script>

</body>
</html>
