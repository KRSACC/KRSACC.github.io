<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ê´€ë¦¬ì - KRSACC</title>
<style>
body { font-family: Arial; background:#f5f5f5; padding:20px; }
.card { background:#fff; border-radius:12px; padding:18px; margin:12px auto; max-width:800px; }
.item { border:1px solid #eee; border-radius:10px; padding:12px; margin-top:10px; }
button { padding:8px 12px; border:none; border-radius:8px; background:#111; color:#fff; cursor:pointer; }
button.danger { background:#b00020; }
.muted { color:#777; font-size:13px; }
</style>
</head>
<body>

<h1>ê´€ë¦¬ì í˜ì´ì§€</h1>

<div class="card">
<h3>ì¶©ì „ ìš”ì²­</h3>
<div id="chargeList">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
</div>

<div class="card">
<h3>êµ¬ë§¤ ìš”ì²­</h3>
<div id="purchaseList">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
</div>

<script type="module">
import { auth, db } from "./firebase.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import {
  collection, getDocs, query, where,
  doc, updateDoc, increment, addDoc
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const ADMIN_EMAIL = "killgg0108@gmail.com";
const chargeList = document.getElementById("chargeList");
const purchaseList = document.getElementById("purchaseList");

onAuthStateChanged(auth, async user => {
  if (!user || user.email !== ADMIN_EMAIL) {
    alert("ê´€ë¦¬ìë§Œ ì ‘ê·¼ ê°€ëŠ¥");
    location.href = "index.html";
    return;
  }

  loadCharges();
  loadPurchases();
});

async function loadCharges() {
  chargeList.innerHTML = "";
  const q = query(collection(db,"chargeRequests"), where("status","==","pending"));
  const snap = await getDocs(q);

  if (snap.empty) {
    chargeList.innerHTML = "<div class='muted'>ëŒ€ê¸°ì¤‘ ì—†ìŒ</div>";
    return;
  }

  snap.forEach(d => {
    const r = d.data();
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <b>${r.amount}ì›</b> / ${r.email}<br>
      <button>ìŠ¹ì¸</button>
    `;
    div.querySelector("button").onclick = async () => {
      await updateDoc(doc(db,"users",r.uid), { balance: increment(r.amount) });
      await updateDoc(doc(db,"chargeRequests",d.id), { status:"approved" });

      // ğŸ”” ì•Œë¦¼ ìƒì„±
      await addDoc(collection(db,"notifications"), {
        uid: r.uid,
        message: `${r.amount.toLocaleString()}ì› ì¶©ì „ì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.`,
        createdAt: Date.now()
      });

      alert("ì¶©ì „ ìŠ¹ì¸ ì™„ë£Œ");
      loadCharges();
    };
    chargeList.appendChild(div);
  });
}

async function loadPurchases() {
  purchaseList.innerHTML = "";
  const q = query(collection(db,"purchases"), where("status","==","pending"));
  const snap = await getDocs(q);

  if (snap.empty) {
    purchaseList.innerHTML = "<div class='muted'>ëŒ€ê¸°ì¤‘ ì—†ìŒ</div>";
    return;
  }

  snap.forEach(d => {
    const r = d.data();
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <b>${r.product}</b> / ${r.price}ì›<br>
      <span class="muted">${r.email}</span><br>
      <button>ì²˜ë¦¬ ì™„ë£Œ</button>
    `;
    div.querySelector("button").onclick = async () => {
      await updateDoc(doc(db,"purchases",d.id), { status:"completed" });

      await addDoc(collection(db,"notifications"), {
        uid: r.uid,
        message: `${r.product} ìƒí’ˆ êµ¬ë§¤ê°€ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.`,
        createdAt: Date.now()
      });

      alert("êµ¬ë§¤ ì²˜ë¦¬ ì™„ë£Œ");
      loadPurchases();
    };
    purchaseList.appendChild(div);
  });
}
</script>
</body>
</html>
