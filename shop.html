<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>상품 - KRSACC</title>
  <style>
    :root{
      --bg:#f5f5f5; --card:#fff; --text:#111; --muted:#777; --line:#eee;
      --btn:#111; --btn2:#666; --danger:#b00020; --radius:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{background:linear-gradient(180deg,#111 0%,#0c0c0c 100%);color:#fff;padding:26px 16px;text-align:center}
    header h1{margin:0;font-size:34px;letter-spacing:1px}
    header p{margin:8px 0 0;opacity:.9}

    .topbar{
      background:#fff;border-bottom:1px solid var(--line);
      display:flex;gap:10px;align-items:center;justify-content:space-between;
      padding:10px 14px; position:sticky; top:0; z-index:10;
    }
    .topbar .left{font-size:14px;color:#333}
    .topbar .right{display:flex;gap:8px;flex-wrap:wrap}
    .btn{
      padding:10px 12px;border:none;border-radius:10px;cursor:pointer;
      background:var(--btn);color:#fff;font-weight:800
    }
    .btn.secondary{background:var(--btn2)}
    .btn.danger{background:var(--danger)}
    .wrap{max-width:980px;margin:18px auto;padding:0 14px}
    .card{
      background:var(--card);border-radius:var(--radius);
      padding:18px;margin:14px 0;border:1px solid #f0f0f0;
      box-shadow:0 1px 0 rgba(0,0,0,.03);
    }
    .muted{color:var(--muted);font-size:13px;line-height:1.45}
    .balance{font-size:22px;font-weight:900;margin:10px 0}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .item{
      border:1px solid var(--line);border-radius:14px;padding:14px;background:#fff;
      display:flex;flex-direction:column;gap:10px; overflow:hidden;
    }
    .thumb{
      width:100%; height:150px; border-radius:12px;
      border:1px solid var(--line);
      background:linear-gradient(135deg,#e9e9e9 0%, #f7f7f7 60%, #ececec 100%);
      display:flex; align-items:center; justify-content:center;
      font-weight:900; color:#555;
    }
    .item h3{margin:0;font-size:18px}
    .price{font-weight:900;font-size:16px}
    .row{display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .item .btn{width:100%}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#f1f1f1;border:1px solid #e8e8e8;font-size:12px;color:#444;font-weight:700}
    @media (max-width:900px){ .grid{grid-template-columns:repeat(2,1fr)} }
    @media (max-width:560px){ header h1{font-size:28px} .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>

  <div class="topbar">
    <div class="left" id="loginLabel">확인 중...</div>
    <div class="right">
      <button class="btn secondary" onclick="location.href='index.html'">메인</button>
      <button class="btn secondary" onclick="location.href='charge.html'">충전</button>
      <button class="btn secondary" onclick="location.href='me.html'">내 정보</button>
      <button class="btn danger" id="logoutBtn">로그아웃</button>
    </div>
  </div>

  <header>
    <h1>KRSACC</h1>
    <p>상품 구매</p>
  </header>

  <div class="wrap">
    <div class="card">
      <div class="muted">현재 잔액</div>
      <div class="balance" id="balance">불러오는 중...</div>
      <div class="muted" id="statusMsg"></div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 12px;">상품 목록</h2>
      <div class="grid" id="productGrid"></div>
      <div class="muted" style="margin-top:12px;">
        ※ 구매하면 Firestore에 구매내역이 저장됩니다.
      </div>
    </div>
  </div>

  <script type="module">
    import { auth, db } from "./firebase.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      doc, getDoc,
      collection, doc as doc2,
      runTransaction
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const loginLabel = document.getElementById("loginLabel");
    const balanceEl  = document.getElementById("balance");
    const statusMsg  = document.getElementById("statusMsg");
    const grid       = document.getElementById("productGrid");
    const logoutBtn  = document.getElementById("logoutBtn");

    // ✅ 여기만 바꾸면 상품 추가/수정 가능
    const PRODUCTS = [
      { id:"A", name:"상품A", price:10000, tag:"즉시 차감" },
      { id:"B", name:"상품B", price:20000, tag:"즉시 차감" },
      { id:"C", name:"상품C", price:30000, tag:"즉시 차감" }
    ];

    function fmt(n){ return (n||0).toLocaleString(); }

    async function refreshBalance(userRef){
      const snap = await getDoc(userRef);
      const data = snap.data() || {};
      balanceEl.textContent = fmt(data.balance || 0) + "원";
      return Number(data.balance || 0);
    }

    function renderProducts(user, userRef){
      grid.innerHTML = "";

      PRODUCTS.forEach((p) => {
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div class="thumb">상품 이미지</div>
          <div class="row">
            <h3>${p.name}</h3>
            <span class="pill">${p.tag}</span>
          </div>
          <div class="price">${fmt(p.price)}원</div>
          <button class="btn" id="buy-${p.id}">구매하기</button>
        `;
        grid.appendChild(div);

        const btn = div.querySelector(`#buy-${p.id}`);

        btn.onclick = async () => {
          btn.disabled = true;
          btn.textContent = "처리 중...";
          statusMsg.textContent = "구매 처리 중...";

          try {
            await runTransaction(db, async (tx) => {
              const userSnap = await tx.get(userRef);
              if (!userSnap.exists()) throw new Error("users 문서가 없습니다. (회원가입 시 users 생성 필요)");

              const data = userSnap.data() || {};
              const bal = Number(data.balance || 0);

              if (bal < p.price) throw new Error("잔액이 부족합니다.");

              // 잔액 차감
              tx.update(userRef, { balance: bal - p.price });

              // 구매내역 저장 (purchases 컬렉션)
              const purchasesCol = collection(db, "purchases");
              const purchaseRef = doc2(purchasesCol);
              tx.set(purchaseRef, {
                uid: user.uid,
                email: user.email || "",
                productId: p.id,
                productName: p.name,
                price: p.price,
                createdAt: Date.now()
              });
            });

            await refreshBalance(userRef);
            statusMsg.textContent = "구매 완료!";
            alert("구매 완료!");
          } catch (e) {
            console.error(e);
            statusMsg.textContent = "오류: " + (e?.message || e);
            alert("오류: " + (e?.message || e));
          } finally {
            btn.disabled = false;
            btn.textContent = "구매하기";
          }
        };
      });
    }

    logoutBtn.onclick = async () => {
      await signOut(auth);
      location.href = "login.html";
    };

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        location.href = "login.html";
        return;
      }

      loginLabel.textContent = "로그인됨: " + (user.email || user.uid);

      const userRef = doc(db, "users", user.uid);

      try {
        await refreshBalance(userRef);
        renderProducts(user, userRef);
        statusMsg.textContent = "";
      } catch (e) {
        console.error(e);
        statusMsg.textContent = "오류: " + (e?.message || e);
      }
    });
  </script>

</body>
</html>
