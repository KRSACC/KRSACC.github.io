<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>상품 - KRSACC</title>
</head>
<body>

<h1>상품</h1>

<button onclick="buy('상품A', 10000)">상품A (10,000원)</button>

<script type="module">
import { auth, db } from "./firebase.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { doc, getDoc, updateDoc, addDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

onAuthStateChanged(auth, user => {
  if (!user) location.href = "login.html";
});

async function buy(name, price) {
  const user = auth.currentUser;
  const ref = doc(db,"users",user.uid);
  const snap = await getDoc(ref);
  const bal = snap.data().balance || 0;

  if (bal < price) {
    alert("잔액 부족");
    return;
  }

  await updateDoc(ref, { balance: bal - price });

  await addDoc(collection(db,"purchases"), {
    uid: user.uid,
    email: user.email,
    product: name,
    price,
    status: "pending",
    createdAt: Date.now()
  });

  alert("구매 요청 완료 (관리자 처리 대기)");
}
</script>
</body>
</html>
