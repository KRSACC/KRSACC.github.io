<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>상품 - KRSACC</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f5f5f5; margin:0; padding:20px; }
    h1 { text-align:center; margin: 8px 0 18px; }
    .card { background:#fff; border-radius:12px; padding:18px; margin:12px auto; max-width:760px; }
    .product { background:#fff; border-radius:12px; padding:16px; margin:12px auto; max-width:520px; text-align:center; }
    img { width:100%; border-radius:12px; }
    button { margin-top:10px; width:100%; padding:12px; background:#111; color:#fff; border:none; border-radius:10px; cursor:pointer; }
    .row { display:flex; gap:10px; flex-wrap:wrap; }
    .row button { width:auto; }
    .muted { color:#777; font-size:13px; margin-top:8px; line-height:1.45; }
    .badge { display:inline-block; padding:4px 8px; border-radius:999px; background:#eee; font-size:12px; }
  </style>
</head>
<body>

<h1>상품 목록</h1>

<div class="card">
  <div><b>현재 잔액:</b> <span id="balance">불러오는 중...</span></div>
  <div class="muted" id="userInfo"></div>
  <div class="row" style="margin-top:10px;">
    <button onclick="location.href='index.html'">메인으로</button>
    <button onclick="location.href='charge.html'">충전하기</button>
  </div>
  <div class="muted">
    ※ 구매하면 Firestore 잔액(users.balance)에서 바로 차감됩니다.
  </div>
</div>

<!-- ✅ 상품들 (원하는 만큼 복붙해서 늘리면 됨) -->
<div class="product">
  <img src="https://via.placeholder.com/400x250" alt="상품 이미지">
  <h2>상품명 예시 1</h2>
  <p>가격: <b>10,000원</b> <span class="badge">즉시 차감</span></p>
  <button id="buy1">구매하기</button>
</div>

<div class="product">
  <img src="https://via.placeholder.com/400x250" alt="상품 이미지">
  <h2>상품명 예시 2</h2>
  <p>가격: <b>20,000원</b> <span class="badge">즉시 차감</span></p>
  <button id="buy2">구매하기</button>
</div>

<div class="product">
  <img src="https://via.placeholder.com/400x250" alt="상품 이미지">
  <h2>상품명 예시 3</h2>
  <p>가격: <b>30,000원</b> <span class="badge">즉시 차감</span></p>
  <button id="buy3">구매하기</button>
</div>

<script type="module">
  import { auth, db } from "./firebase.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import {
    doc, getDoc, setDoc, runTransaction,
    collection, addDoc
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const balanceEl = document.getElementById("balance");
  const userInfoEl = document.getElementById("userInfo");

  async function ensureUserDoc(user) {
    const ref = doc(db, "users", user.uid);
    const snap = await getDoc(ref);
    if (!snap.exists()) {
      await setDoc(ref, { email: user.email || "", balance: 0, createdAt: Date.now() });
    }
    return ref;
  }

  async function refreshBalance(userRef) {
    const snap = await getDoc(userRef);
    const data = snap.data() || {};
    balanceEl.innerText = ((data.balance || 0).toLocaleString()) + "원";
    return data.balance || 0;
  }

  // ✅ 구매: Firestore 잔액에서 차감 + 주문내역 저장
  async function buy(user, userRef, price, name) {
    // 1) 트랜잭션으로 잔액 확인 후 차감(동시 구매에도 안전)
    await runTransaction(db, async (tx) => {
      const snap = await tx.get(userRef);
      const data = snap.data() || {};
      const balance = Number(data.balance || 0);

      if (balance < price) {
        throw new Error("잔액이 부족합니다.");
      }

      tx.update(userRef, { balance: balance - price });
    });

    // 2) 주문 기록(관리자 확인용)
    await addDoc(collection(db, "orders"), {
      uid: user.uid,
      email: user.email || "",
      product: name,
      price,
      status: "pending",
      createdAt: Date.now()
    });

    alert("구매 요청이 접수되었습니다.\n관리자 확인 후 처리됩니다.");
    await refreshBalance(userRef);
  }

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      alert("로그인이 필요합니다.");
      location.href = "login.html";
      return;
    }

    userInfoEl.innerText = "로그인: " + (user.email || user.uid);

    const userRef = await ensureUserDoc(user);
    await refreshBalance(userRef);

    // 버튼 연결
    document.getElementById("buy1").onclick = () => buy(user, userRef, 10000, "상품명 예시 1").catch(e => alert(e.message));
    document.getElementById("buy2").onclick = () => buy(user, userRef, 20000, "상품명 예시 2").catch(e => alert(e.message));
    document.getElementById("buy3").onclick = () => buy(user, userRef, 30000, "상품명 예시 3").catch(e => alert(e.message));
  });
</script>

</body>
</html>
